{{/* 검색 버튼 컴포넌트 */}}
<button 
  id="search-toggle" 
  class="search-toggle-button"
  aria-label="{{ if eq .Language.Lang "ko" }}검색{{ else }}Search{{ end }}"
  title="{{ if eq .Language.Lang "ko" }}검색 (Ctrl+K){{ else }}Search (Ctrl+K){{ end }}"
>
  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M19 19L13 13M15 8C15 11.866 11.866 15 8 15C4.13401 15 1 11.866 1 8C1 4.13401 4.13401 1 8 1C11.866 1 15 4.13401 15 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<div id="search-modal" class="search-modal" style="display: none;">
  <div class="search-modal-overlay"></div>
  <div class="search-modal-content">
    <button class="search-modal-close" aria-label="{{ if eq .Language.Lang "ko" }}닫기{{ else }}Close{{ end }}">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    {{ partial "search.html" . }}
  </div>
</div>

<script>
(function() {
  const searchToggle = document.getElementById('search-toggle');
  const searchModal = document.getElementById('search-modal');
  const searchModalClose = searchModal.querySelector('.search-modal-close');
  const searchModalOverlay = searchModal.querySelector('.search-modal-overlay');
  
  async function openSearch() {
    searchModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Pagefind UI 초기화 (아직 초기화되지 않았다면)
    if (typeof window.initPagefind === 'function') {
      await window.initPagefind();
    }
    
    // 검색 입력창 초기화 (뒤로가기 등으로 인한 이전 상태 제거)
    const searchInput = searchModal.querySelector('input[type="search"], input[type="text"], .pagefind-ui__search-input');
    if (searchInput) {
      searchInput.value = '';
      // 검색 결과도 초기화
      const searchResults = searchModal.querySelector('.pagefind-ui__results-area');
      if (searchResults) {
        searchResults.innerHTML = '';
      }
      // input 이벤트 트리거하여 Pagefind UI 상태 초기화
      searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    // 검색 입력창에 포커스 (Pagefind UI가 완전히 렌더링될 때까지 대기)
    const focusInput = () => {
      const input = searchModal.querySelector('input[type="search"], input[type="text"], .pagefind-ui__search-input');
      if (input) {
        input.focus();
        input.click(); // 클릭 이벤트도 트리거
        return true;
      }
      return false;
    };
    
    // 여러 번 시도 (Pagefind UI 렌더링 대기)
    let attempts = 0;
    const maxAttempts = 10;
    const tryFocus = () => {
      if (!focusInput() && attempts < maxAttempts) {
        attempts++;
        setTimeout(tryFocus, 100);
      }
    };
    
    setTimeout(tryFocus, 100);
  }
  
  function closeSearch() {
    // 검색 입력창 초기화
    const searchInput = searchModal.querySelector('input[type="search"], input[type="text"], .pagefind-ui__search-input');
    if (searchInput) {
      searchInput.value = '';
      // Pagefind UI의 검색 결과도 초기화
      const searchResults = searchModal.querySelector('.pagefind-ui__results-area');
      if (searchResults) {
        searchResults.innerHTML = '';
      }
      // 검색 이벤트 트리거하여 결과 초기화
      searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    searchModal.style.display = 'none';
    document.body.style.overflow = '';
  }
  
  // 검색 버튼 클릭
  if (searchToggle) {
    searchToggle.addEventListener('click', openSearch);
  }
  
  // 닫기 버튼 클릭
  if (searchModalClose) {
    searchModalClose.addEventListener('click', closeSearch);
  }
  
  // 오버레이 클릭 시 닫기
  if (searchModalOverlay) {
    searchModalOverlay.addEventListener('click', closeSearch);
  }
  
  // ESC 키로 닫기
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && searchModal.style.display === 'block') {
      closeSearch();
    }
    // Ctrl+K 또는 Cmd+K로 열기
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      if (searchModal.style.display === 'block') {
        closeSearch();
      } else {
        openSearch();
      }
    }
  });
  
  // 뒤로가기/앞으로가기 시 검색창 초기화 (BFCache 대응)
  window.addEventListener('pageshow', function(event) {
    // BFCache에서 복원된 경우 (persisted = true)
    if (event.persisted) {
      const searchInput = searchModal.querySelector('input[type="search"], input[type="text"], .pagefind-ui__search-input');
      if (searchInput) {
        searchInput.value = '';
        // 검색 결과도 초기화
        const searchResults = searchModal.querySelector('.pagefind-ui__results-area');
        if (searchResults) {
          searchResults.innerHTML = '';
        }
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
      }
    }
  });
})();
</script>
